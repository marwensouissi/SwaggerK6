pipeline {
    agent any

    environment {
        BITBUCKET_REPO = "https://bitbucket.org/ndammak/itona-k6.git"
        BITBUCKET_CRED_ID = 'bbck'
        K6_WEB_DASHBOARD = "true"
        XK6_PATH = "/var/lib/jenkins/go/bin/xk6"  // Set full path for Jenkins
    }

    stages {
        stage('Checkout Code') {
            steps {
                script {
                    echo "üîÑ Fetching code from Bitbucket..."
                    git branch: 'main',
                        credentialsId: BITBUCKET_CRED_ID,
                        url: BITBUCKET_REPO
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                script {
                    sh '''
                    echo "‚öôÔ∏è Installing K6 and dependencies..."
                    sudo apt update
                    sudo apt install -y k6 nodejs npm
                    go install go.k6.io/xk6/cmd/xk6@latest
                    sudo docker pull grafana/xk6
                    sudo docker pull eclipse-mosquitto
                    '''
                }
            }
        }

        stage('Build xK6 with MQTT and File Plugins') {
            steps {
                script {
                    sh '''
                    echo "üî® Building xK6 with MQTT plugin..."
                    $XK6_PATH build v0.54.0 \
                        --with github.com/pmalhaire/xk6-mqtt@latest \
                        --with github.com/avitalique/xk6-file@latest
                    '''
                }
            }
        }

        stage('Start MQTT Broker') {
            steps {
                script {
                    sh '''
                    echo "üöÄ Starting MQTT Broker..."
                    sudo docker run --rm --name mosquitto -d -p 1883:1883 eclipse-mosquitto mosquitto -c /mosquitto-no-auth.conf
                    '''
                }
            }
        }

        stage('Run K6 Device Test') {
            steps {
                script {
                    sh '''
                    echo "üì° Running K6 device_test.js scenario..."
                    ./k6 run --duration 3m --vus 3 final/device_test.js
                    '''
                }
            }
        }

        stage('Fix JSON Output') {
            steps {
                script {
                    sh '''
                    echo "üõ†Ô∏è Fixing JSON output with Node.js formatter..."
                    node JsonFormatter
                    '''
                }
            }
        }

        stage('Run MQTT Connection Test') {
            steps {
                script {
                    sh '''
                    echo "üîó Running MQTT connection test..."
                    ./k6 run --duration 3m --vus 3 final/Mqtt_connection.js
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "‚úÖ Pipeline execution completed!"
        }
        success {
            echo "üéâ All K6 and MQTT Tests Passed!"
        }
        failure {
            echo "‚ùå Some tests failed!"
        }
    }
}
