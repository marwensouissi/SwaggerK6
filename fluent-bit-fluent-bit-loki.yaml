fluent-bit:
  enabled: true
  config:
    service: |
      [SERVICE]
          HTTP_Server    On
          HTTP_Listen    0.0.0.0
          HTTP_PORT      2020
          Flush          1
          Daemon         Off
          Log_Level      warn
          Parsers_File   parsers.conf

    inputs: |
      [INPUT]
          Name              tail
          Tag               kube.*
          Path              /var/log/containers/*.log
          Parser            docker
          DB                /run/fluent-bit/flb_kube.db
          Mem_Buf_Limit     5MB
          Buffer_Chunk_size 32k
          Buffer_Max_size   32k

    filters: |
      [FILTER]
          Name           kubernetes
          Match          kube.*
          Kube_URL       https://kubernetes.default.svc:443
          Merge_Log      On
          K8S-Logging.Exclude Off
          K8S-Logging.Parser  Off
          Labels         On
          Annotations    Off

    outputs: |
      [OUTPUT]
          Name          loki
          Match         kube.*
          Url           http://loki:3100/loki/api/v1/push
          TenantID      ""
          BatchWait     1
          BatchSize     1048576
          Labels        {job="fluent-bit"}
          RemoveKeys    kubernetes,stream
          AutoKubernetesLabels false
          LabelMapPath  /fluent-bit/etc/labelmap.json
          LineFormat    json
          LogLevel      warn

    customParsers: |
      [PARSER]
          Name        docker
          Format      json
          Time_Key    time
          Time_Format %Y-%m-%dT%H:%M:%S.%L

    customParsersConfig: true

    extraFiles:
      labelmap.json: |
        {
          "kubernetes": {
            "container_name": "container",
            "host": "node",
            "labels": {
              "app": "app",
              "release": "release"
            },
            "namespace_name": "namespace",
            "pod_name": "instance"
          },
          "stream": "stream"
        }
