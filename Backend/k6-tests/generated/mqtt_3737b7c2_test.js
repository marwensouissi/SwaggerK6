import { sleep } from 'k6';
import mqtt from 'k6/x/mqtt';
import { SharedArray } from 'k6/data';
import { check } from 'k6';

// Shared credentials list using SharedArray (inline, not file-based)
const credentialsData = new SharedArray('device_credentials', () => {
    return [
        { credentialsId: "credential_1" },        { credentialsId: "credential_2" },        { credentialsId: "credential_3" },        { credentialsId: "credential_4" },        { credentialsId: "credential_5" },        { credentialsId: "credential_6" },        { credentialsId: "credential_7" },        { credentialsId: "credential_8" },        { credentialsId: "credential_9" },        { credentialsId: "credential_10" },        { credentialsId: "credential_11" },        { credentialsId: "credential_12" },        { credentialsId: "credential_13" },        { credentialsId: "credential_14" },        { credentialsId: "credential_15" },        { credentialsId: "credential_16" },        { credentialsId: "credential_17" },        { credentialsId: "credential_18" },        { credentialsId: "credential_19" },        { credentialsId: "credential_20" },        { credentialsId: "credential_21" },        { credentialsId: "credential_22" },        { credentialsId: "credential_23" },        { credentialsId: "credential_24" },        { credentialsId: "credential_25" },        { credentialsId: "credential_26" },        { credentialsId: "credential_27" },        { credentialsId: "credential_28" },        { credentialsId: "credential_29" },        { credentialsId: "credential_30" },        { credentialsId: "credential_31" },        { credentialsId: "credential_32" },        { credentialsId: "credential_33" },        { credentialsId: "credential_34" },        { credentialsId: "credential_35" },        { credentialsId: "credential_36" },        { credentialsId: "credential_37" },        { credentialsId: "credential_38" },        { credentialsId: "credential_39" },        { credentialsId: "credential_40" },        { credentialsId: "credential_41" },        { credentialsId: "credential_42" },        { credentialsId: "credential_43" },        { credentialsId: "credential_44" },        { credentialsId: "credential_45" },        { credentialsId: "credential_46" },        { credentialsId: "credential_47" },        { credentialsId: "credential_48" },        { credentialsId: "credential_49" },        { credentialsId: "credential_50" },        { credentialsId: "credential_51" },        { credentialsId: "credential_52" },        { credentialsId: "credential_53" },        { credentialsId: "credential_54" },        { credentialsId: "credential_55" },        { credentialsId: "credential_56" },        { credentialsId: "credential_57" },        { credentialsId: "credential_58" },        { credentialsId: "credential_59" },        { credentialsId: "credential_60" },        { credentialsId: "credential_61" },        { credentialsId: "credential_62" },        { credentialsId: "credential_63" },        { credentialsId: "credential_64" },        { credentialsId: "credential_65" },        { credentialsId: "credential_66" },        { credentialsId: "credential_67" },        { credentialsId: "credential_68" },        { credentialsId: "credential_69" },        { credentialsId: "credential_70" },        { credentialsId: "credential_71" },        { credentialsId: "credential_72" },        { credentialsId: "credential_73" },        { credentialsId: "credential_74" },        { credentialsId: "credential_75" },        { credentialsId: "credential_76" },        { credentialsId: "credential_77" },        { credentialsId: "credential_78" },        { credentialsId: "credential_79" },        { credentialsId: "credential_80" },        { credentialsId: "credential_81" },        { credentialsId: "credential_82" },        { credentialsId: "credential_83" },        { credentialsId: "credential_84" },        { credentialsId: "credential_85" },        { credentialsId: "credential_86" },        { credentialsId: "credential_87" },        { credentialsId: "credential_88" },        { credentialsId: "credential_89" },        { credentialsId: "credential_90" },        { credentialsId: "credential_91" },        { credentialsId: "credential_92" },        { credentialsId: "credential_93" },        { credentialsId: "credential_94" },        { credentialsId: "credential_95" },        { credentialsId: "credential_96" },        { credentialsId: "credential_97" },        { credentialsId: "credential_98" },        { credentialsId: "credential_99" },        { credentialsId: "credential_100" },        { credentialsId: "credential_101" },        { credentialsId: "credential_102" },        { credentialsId: "credential_103" },        { credentialsId: "credential_104" },        { credentialsId: "credential_105" },        { credentialsId: "credential_106" },        { credentialsId: "credential_107" },        { credentialsId: "credential_108" },        { credentialsId: "credential_109" },        { credentialsId: "credential_110" },        { credentialsId: "credential_111" },        { credentialsId: "credential_112" },        { credentialsId: "credential_113" },        { credentialsId: "credential_114" },        { credentialsId: "credential_115" },        { credentialsId: "credential_116" },        { credentialsId: "credential_117" },        { credentialsId: "credential_118" },        { credentialsId: "credential_119" },        { credentialsId: "credential_120" },        { credentialsId: "credential_121" },        { credentialsId: "credential_122" },        { credentialsId: "credential_123" },        { credentialsId: "credential_124" },        { credentialsId: "credential_125" },        { credentialsId: "credential_126" },        { credentialsId: "credential_127" },        { credentialsId: "credential_128" },        { credentialsId: "credential_129" },        { credentialsId: "credential_130" },        { credentialsId: "credential_131" },        { credentialsId: "credential_132" },        { credentialsId: "credential_133" },        { credentialsId: "credential_134" },        { credentialsId: "credential_135" },        { credentialsId: "credential_136" },        { credentialsId: "credential_137" },        { credentialsId: "credential_138" },        { credentialsId: "credential_139" },        { credentialsId: "credential_140" },        { credentialsId: "credential_141" },        { credentialsId: "credential_142" },        { credentialsId: "credential_143" },        { credentialsId: "credential_144" },        { credentialsId: "credential_145" },        { credentialsId: "credential_146" },        { credentialsId: "credential_147" },        { credentialsId: "credential_148" },        { credentialsId: "credential_149" },        { credentialsId: "credential_150" },        { credentialsId: "credential_151" },        { credentialsId: "credential_152" },        { credentialsId: "credential_153" },        { credentialsId: "credential_154" },        { credentialsId: "credential_155" },        { credentialsId: "credential_156" },        { credentialsId: "credential_157" },        { credentialsId: "credential_158" },        { credentialsId: "credential_159" },        { credentialsId: "credential_160" },        { credentialsId: "credential_161" },        { credentialsId: "credential_162" },        { credentialsId: "credential_163" },        { credentialsId: "credential_164" },        { credentialsId: "credential_165" },        { credentialsId: "credential_166" },        { credentialsId: "credential_167" },        { credentialsId: "credential_168" },        { credentialsId: "credential_169" },        { credentialsId: "credential_170" },        { credentialsId: "credential_171" },        { credentialsId: "credential_172" },        { credentialsId: "credential_173" },        { credentialsId: "credential_174" },        { credentialsId: "credential_175" },        { credentialsId: "credential_176" },        { credentialsId: "credential_177" },        { credentialsId: "credential_178" },        { credentialsId: "credential_179" },        { credentialsId: "credential_180" },        { credentialsId: "credential_181" },        { credentialsId: "credential_182" },        { credentialsId: "credential_183" },        { credentialsId: "credential_184" },        { credentialsId: "credential_185" },        { credentialsId: "credential_186" },        { credentialsId: "credential_187" },        { credentialsId: "credential_188" },        { credentialsId: "credential_189" },        { credentialsId: "credential_190" },        { credentialsId: "credential_191" },        { credentialsId: "credential_192" },        { credentialsId: "credential_193" },        { credentialsId: "credential_194" },        { credentialsId: "credential_195" },        { credentialsId: "credential_196" },        { credentialsId: "credential_197" },        { credentialsId: "credential_198" },        { credentialsId: "credential_199" },        { credentialsId: "credential_200" },        { credentialsId: "credential_201" },        { credentialsId: "credential_202" },        { credentialsId: "credential_203" },        { credentialsId: "credential_204" },        { credentialsId: "credential_205" },        { credentialsId: "credential_206" },        { credentialsId: "credential_207" },        { credentialsId: "credential_208" },        { credentialsId: "credential_209" },        { credentialsId: "credential_210" },        { credentialsId: "credential_211" },        { credentialsId: "credential_212" },        { credentialsId: "credential_213" },        { credentialsId: "credential_214" },        { credentialsId: "credential_215" },        { credentialsId: "credential_216" },        { credentialsId: "credential_217" },        { credentialsId: "credential_218" },        { credentialsId: "credential_219" },        { credentialsId: "credential_220" },        { credentialsId: "credential_221" },        { credentialsId: "credential_222" },        { credentialsId: "credential_223" },        { credentialsId: "credential_224" },        { credentialsId: "credential_225" },        { credentialsId: "credential_226" },        { credentialsId: "credential_227" },        { credentialsId: "credential_228" },        { credentialsId: "credential_229" },        { credentialsId: "credential_230" },        { credentialsId: "credential_231" },        { credentialsId: "credential_232" },        { credentialsId: "credential_233" },        { credentialsId: "credential_234" },        { credentialsId: "credential_235" },        { credentialsId: "credential_236" },        { credentialsId: "credential_237" },        { credentialsId: "credential_238" },        { credentialsId: "credential_239" },        { credentialsId: "credential_240" },        { credentialsId: "credential_241" },        { credentialsId: "credential_242" },        { credentialsId: "credential_243" },        { credentialsId: "credential_244" },        { credentialsId: "credential_245" },        { credentialsId: "credential_246" },        { credentialsId: "credential_247" },        { credentialsId: "credential_248" },        { credentialsId: "credential_249" },        { credentialsId: "credential_250" },        { credentialsId: "credential_251" },        { credentialsId: "credential_252" },        { credentialsId: "credential_253" },        { credentialsId: "credential_254" },        { credentialsId: "credential_255" },        { credentialsId: "credential_256" },        { credentialsId: "credential_257" },        { credentialsId: "credential_258" },        { credentialsId: "credential_259" },        { credentialsId: "credential_260" },        { credentialsId: "credential_261" },        { credentialsId: "credential_262" },        { credentialsId: "credential_263" },        { credentialsId: "credential_264" },        { credentialsId: "credential_265" },        { credentialsId: "credential_266" },        { credentialsId: "credential_267" },        { credentialsId: "credential_268" },        { credentialsId: "credential_269" },        { credentialsId: "credential_270" },        { credentialsId: "credential_271" },        { credentialsId: "credential_272" },        { credentialsId: "credential_273" },        { credentialsId: "credential_274" },        { credentialsId: "credential_275" },        { credentialsId: "credential_276" },        { credentialsId: "credential_277" },        { credentialsId: "credential_278" },        { credentialsId: "credential_279" },        { credentialsId: "credential_280" },        { credentialsId: "credential_281" },        { credentialsId: "credential_282" },        { credentialsId: "credential_283" },        { credentialsId: "credential_284" },        { credentialsId: "credential_285" },        { credentialsId: "credential_286" },        { credentialsId: "credential_287" },        { credentialsId: "credential_288" },        { credentialsId: "credential_289" },        { credentialsId: "credential_290" },        { credentialsId: "credential_291" },        { credentialsId: "credential_292" },        { credentialsId: "credential_293" },        { credentialsId: "credential_294" },        { credentialsId: "credential_295" },        { credentialsId: "credential_296" },        { credentialsId: "credential_297" },        { credentialsId: "credential_298" },        { credentialsId: "credential_299" },        { credentialsId: "credential_300" },        { credentialsId: "credential_301" },        { credentialsId: "credential_302" },        { credentialsId: "credential_303" },        { credentialsId: "credential_304" },        { credentialsId: "credential_305" },        { credentialsId: "credential_306" },        { credentialsId: "credential_307" },        { credentialsId: "credential_308" },        { credentialsId: "credential_309" },        { credentialsId: "credential_310" },        { credentialsId: "credential_311" },        { credentialsId: "credential_312" },        { credentialsId: "credential_313" },        { credentialsId: "credential_314" },        { credentialsId: "credential_315" },        { credentialsId: "credential_316" },        { credentialsId: "credential_317" },        { credentialsId: "credential_318" },        { credentialsId: "credential_319" },        { credentialsId: "credential_320" },        { credentialsId: "credential_321" },        { credentialsId: "credential_322" },        { credentialsId: "credential_323" },        { credentialsId: "credential_324" },        { credentialsId: "credential_325" },        { credentialsId: "credential_326" },        { credentialsId: "credential_327" },        { credentialsId: "credential_328" },        { credentialsId: "credential_329" },        { credentialsId: "credential_330" },        { credentialsId: "credential_331" },        { credentialsId: "credential_332" },        { credentialsId: "credential_333" },        { credentialsId: "credential_334" },        { credentialsId: "credential_335" },        { credentialsId: "credential_336" },        { credentialsId: "credential_337" },        { credentialsId: "credential_338" },        { credentialsId: "credential_339" },        { credentialsId: "credential_340" },        { credentialsId: "credential_341" },        { credentialsId: "credential_342" },        { credentialsId: "credential_343" },        { credentialsId: "credential_344" },        { credentialsId: "credential_345" },        { credentialsId: "credential_346" },        { credentialsId: "credential_347" },        { credentialsId: "credential_348" },        { credentialsId: "credential_349" },        { credentialsId: "credential_350" },        { credentialsId: "credential_351" },        { credentialsId: "credential_352" },        { credentialsId: "credential_353" },        { credentialsId: "credential_354" },        { credentialsId: "credential_355" },        { credentialsId: "credential_356" },        { credentialsId: "credential_357" },        { credentialsId: "credential_358" },        { credentialsId: "credential_359" },        { credentialsId: "credential_360" },        { credentialsId: "credential_361" },        { credentialsId: "credential_362" },        { credentialsId: "credential_363" },        { credentialsId: "credential_364" },        { credentialsId: "credential_365" },        { credentialsId: "credential_366" },        { credentialsId: "credential_367" },        { credentialsId: "credential_368" },        { credentialsId: "credential_369" },        { credentialsId: "credential_370" },        { credentialsId: "credential_371" },        { credentialsId: "credential_372" },        { credentialsId: "credential_373" },        { credentialsId: "credential_374" },        { credentialsId: "credential_375" },        { credentialsId: "credential_376" },        { credentialsId: "credential_377" },        { credentialsId: "credential_378" },        { credentialsId: "credential_379" },        { credentialsId: "credential_380" },        { credentialsId: "credential_381" },        { credentialsId: "credential_382" },        { credentialsId: "credential_383" },        { credentialsId: "credential_384" },        { credentialsId: "credential_385" },        { credentialsId: "credential_386" },        { credentialsId: "credential_387" },        { credentialsId: "credential_388" },        { credentialsId: "credential_389" },        { credentialsId: "credential_390" },        { credentialsId: "credential_391" },        { credentialsId: "credential_392" },        { credentialsId: "credential_393" },        { credentialsId: "credential_394" },        { credentialsId: "credential_395" },        { credentialsId: "credential_396" },        { credentialsId: "credential_397" },        { credentialsId: "credential_398" },        { credentialsId: "credential_399" },        { credentialsId: "credential_400" },        { credentialsId: "credential_401" },        { credentialsId: "credential_402" },        { credentialsId: "credential_403" },        { credentialsId: "credential_404" },        { credentialsId: "credential_405" },        { credentialsId: "credential_406" },        { credentialsId: "credential_407" },        { credentialsId: "credential_408" },        { credentialsId: "credential_409" },        { credentialsId: "credential_410" },        { credentialsId: "credential_411" },        { credentialsId: "credential_412" },        { credentialsId: "credential_413" },        { credentialsId: "credential_414" },        { credentialsId: "credential_415" },        { credentialsId: "credential_416" },        { credentialsId: "credential_417" },        { credentialsId: "credential_418" },        { credentialsId: "credential_419" },        { credentialsId: "credential_420" },        { credentialsId: "credential_421" },        { credentialsId: "credential_422" },        { credentialsId: "credential_423" },        { credentialsId: "credential_424" },        { credentialsId: "credential_425" },        { credentialsId: "credential_426" },        { credentialsId: "credential_427" },        { credentialsId: "credential_428" },        { credentialsId: "credential_429" },        { credentialsId: "credential_430" },        { credentialsId: "credential_431" },        { credentialsId: "credential_432" },        { credentialsId: "credential_433" },        { credentialsId: "credential_434" },        { credentialsId: "credential_435" },        { credentialsId: "credential_436" },        { credentialsId: "credential_437" },        { credentialsId: "credential_438" },        { credentialsId: "credential_439" },        { credentialsId: "credential_440" },        { credentialsId: "credential_441" },        { credentialsId: "credential_442" },        { credentialsId: "credential_443" },        { credentialsId: "credential_444" },        { credentialsId: "credential_445" },        { credentialsId: "credential_446" },        { credentialsId: "credential_447" },        { credentialsId: "credential_448" },        { credentialsId: "credential_449" },        { credentialsId: "credential_450" },        { credentialsId: "credential_451" },        { credentialsId: "credential_452" },        { credentialsId: "credential_453" },        { credentialsId: "credential_454" },        { credentialsId: "credential_455" },        { credentialsId: "credential_456" },        { credentialsId: "credential_457" },        { credentialsId: "credential_458" },        { credentialsId: "credential_459" },        { credentialsId: "credential_460" },        { credentialsId: "credential_461" },        { credentialsId: "credential_462" },        { credentialsId: "credential_463" },        { credentialsId: "credential_464" },        { credentialsId: "credential_465" },        { credentialsId: "credential_466" },        { credentialsId: "credential_467" },        { credentialsId: "credential_468" },        { credentialsId: "credential_469" },        { credentialsId: "credential_470" },        { credentialsId: "credential_471" },        { credentialsId: "credential_472" },        { credentialsId: "credential_473" },        { credentialsId: "credential_474" },        { credentialsId: "credential_475" },        { credentialsId: "credential_476" },        { credentialsId: "credential_477" },        { credentialsId: "credential_478" },        { credentialsId: "credential_479" },        { credentialsId: "credential_480" },        { credentialsId: "credential_481" },        { credentialsId: "credential_482" },        { credentialsId: "credential_483" },        { credentialsId: "credential_484" },        { credentialsId: "credential_485" },        { credentialsId: "credential_486" },        { credentialsId: "credential_487" },        { credentialsId: "credential_488" },        { credentialsId: "credential_489" },        { credentialsId: "credential_490" },        { credentialsId: "credential_491" },        { credentialsId: "credential_492" },        { credentialsId: "credential_493" },        { credentialsId: "credential_494" },        { credentialsId: "credential_495" },        { credentialsId: "credential_496" },        { credentialsId: "credential_497" },        { credentialsId: "credential_498" },        { credentialsId: "credential_499" },        { credentialsId: "credential_500" },        { credentialsId: "credential_501" },        { credentialsId: "credential_502" },        { credentialsId: "credential_503" },        { credentialsId: "credential_504" },        { credentialsId: "credential_505" },        { credentialsId: "credential_506" },        { credentialsId: "credential_507" },        { credentialsId: "credential_508" },        { credentialsId: "credential_509" },        { credentialsId: "credential_510" },        { credentialsId: "credential_511" },        { credentialsId: "credential_512" },        { credentialsId: "credential_513" },        { credentialsId: "credential_514" },        { credentialsId: "credential_515" },        { credentialsId: "credential_516" },        { credentialsId: "credential_517" },        { credentialsId: "credential_518" },        { credentialsId: "credential_519" },        { credentialsId: "credential_520" },        { credentialsId: "credential_521" },        { credentialsId: "credential_522" },        { credentialsId: "credential_523" },        { credentialsId: "credential_524" },        { credentialsId: "credential_525" },        { credentialsId: "credential_526" },        { credentialsId: "credential_527" },        { credentialsId: "credential_528" },        { credentialsId: "credential_529" },        { credentialsId: "credential_530" },        { credentialsId: "credential_531" },        { credentialsId: "credential_532" },        { credentialsId: "credential_533" },        { credentialsId: "credential_534" },        { credentialsId: "credential_535" },        { credentialsId: "credential_536" },        { credentialsId: "credential_537" },        { credentialsId: "credential_538" },        { credentialsId: "credential_539" },        { credentialsId: "credential_540" },        { credentialsId: "credential_541" },        { credentialsId: "credential_542" },        { credentialsId: "credential_543" },        { credentialsId: "credential_544" },        { credentialsId: "credential_545" }    ];
});

const VU_COUNT = 545;
const BUFFER_TIME = 5;

export const options = {
    vus: VU_COUNT,
    duration: '55',
    preAllocatedVUs: VU_COUNT,
};

const broker = "5";
const port = "5";
const topic = "5";
const password = "5";

const clients = new Array(VU_COUNT);

// Create clients using inline credentials from SharedArray
for (let i = 0; i < VU_COUNT; i++) {
    const { credentialsId } = credentialsData[i % credentialsData.length]; // Safe wrap
    const clientId = `k6-client-${i + 1}`;

    try {
        const client = new mqtt.Client(
            [`${broker}:${port}`],
            credentialsId,
            password,
            false,
            clientId,
            5000,
            "", "", "",
            {
                sentBytesLabel: "mqtt_sent_bytes",
                receivedBytesLabel: "mqtt_received_bytes",
                sentMessagesCountLabel: "mqtt_sent_messages_count",
                receivedMessagesCountLabel: "mqtt_received_messages_count",
            },
            false,
        );
        clients[i] = client;
        console.log(`âœ… Client ${i + 1} connected with credentialsId ${ credentialsId }`);
    } catch (err) {
        console.error(`âŒ Client ${i + 1} connection failed`, err);
    }
}

// Main test loop
export default function () {
    const vuId = __VU;
    const client = clients[(vuId - 1) % clients.length]; // Safe index

    if (!client) {
        console.error(`âŒ No MQTT client for VU ${vuId}`);
        return;
    }

    client.connect();
    sleep(2);

    check(client, {
        "is publisher connected": publisher => publisher.isConnected()
    });

    for (let i = 0; i < 5; i++) {
        try {
            const payload = JSON.stringify({
                temperature: (Math.random() * 50).toFixed(2),
                humidity: (Math.random() * 100).toFixed(2),
                timestamp: new Date().toISOString()
            });
            client.publish(topic, 1, payload, false, 5000);
            console.log(`ğŸ“¡ VU ${vuId} published: ${payload}`);
        } catch (err) {
            console.error(`âŒ VU ${vuId} publish failed`, err);
        }
        sleep(BUFFER_TIME);
    }
}

// Graceful shutdown
export function teardown() {
    console.log("ğŸ”Œ Disconnecting MQTT clients...");
    for (let i = 0; i < clients.length; i++) {
        const client = clients[i];
        if (client) {
            try {
                client.close();
                console.log(`âœ… Client ${i + 1} disconnected`);
            } catch (err) {
                console.error(`âŒ Error disconnecting client ${i + 1}`, err);
            }
        }
    }
}