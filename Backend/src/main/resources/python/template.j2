import {
get_abstract_with_payload,
get_abstract_without_payload,
post_abstract_with_payload,
patch_abstract_with_payload,
delete_abstract_without_payload,
put_abstract_with_payload
} from './k6/utils/abstract.js';
import { signup, login } from './k6/AuthManagement/auth.js';
import { randomString } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';

const PASSWORD = "123123123";

export let options = {
stages: [
{% for stage in stages %}
    { duration: '{{ stage.duration }}', target: {{ stage.target }} }{% if not loop.last %},{% endif %}
{% endfor %}
]
};

export default function () {
const user = signup();
const token = login(user.email, PASSWORD);

{% for test in tests %}
    {% if test.method in ["POST", "PUT", "PATCH"] %}
        const {{ test.save_as | default(test.function) }} = {{ test.method.lower() }}_abstract_with_payload({
        url: `{{ test.url | replace("{{token}}", "${token}") }}`,
        token: token,
        tag: "{{ test.function }}",
        job: "{{ test.function }}",
        {% if test.payload is defined %}
            payload: {{ test.payload | tojson | regex_replace('"\\{\\{(randomString\\(\\d+\\))\\}\\}"', '\\1') }}
        {% else %}
            payload: {}
        {% endif %}
        });
    {% elif test.method == "DELETE" %}
        delete_abstract_without_payload({
        url: `{{ test.url | replace("{{token}}", "${token}") | regex_replace("\\{\\{(\\w+)\\.id\\.id\\}\\}", "${\\1.data.id.id}") }}`,
        token: token,
        tag: "{{ test.function }}",
        job: "{{ test.function }}"
        });
    {% endif %}
{% endfor %}
}
