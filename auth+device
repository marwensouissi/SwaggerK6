import http from 'k6/http';
import { check, sleep } from 'k6';
import { randomString } from 'https://jslib.k6.io/k6-utils/1.2.0/index.js';
import mqtt from 'k6/x/mqtt';

export let options = {
    vus: 20, // Simulate 20 virtual users
    iterations: 20, // Each VU runs only once
};

export default function () {
    let userId = __VU; // Virtual User ID (1 to 20)
    let email = `testeurds${userId}_${randomString(5)}@testing.com`; // Unique email
    let firstName = `User${userId}`;
    let lastName = `Test${userId}`;
    let password = '123123';
    let verificationCode = '123456';

    let headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json, text/plain, */*',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
    };

    // Step 1: Signup
    let signupPayload = JSON.stringify({
        email: email,
        firstName: firstName,
        lastName: lastName,
        password: password,
        phone: '12345678',
        appSecret: '6LeoAzodAAAAAGtwzzizL35nh8PqMtlveJMeTHHv'
    });

    console.log(signupPayload);

    let signupResponse = http.post('https://dev-itona.xyz/api/noauth/signup', signupPayload, { headers: headers });
    let signupSuccess = check(signupResponse, { 'Signup successful': (r) => r.status === 200 });
    if (signupSuccess) {
        console.log(`‚úÖ Working: ${email}`);
        sleep(3);
        let token = login(email, password); // Call login function after successful signup
        if (token) {
            createDevice(token); // Create device if login is successful
        }
    } else { 
        console.log(`‚ùå Signup failed for ${email}: `, signupResponse.status, signupResponse.body);
    }
    
    sleep(3);

    // Step 2: Verification
    let verificationPayload = JSON.stringify({
        email: email,
        otpCode: verificationCode
    });

    let verificationResponse = http.post('https://dev-itona.xyz/api/noauth/autoLoginByEmail', verificationPayload, { headers: headers });
    let verificationSuccess = check(verificationResponse, { 'Verification successful': (r) => r.status === 200 });
    if (!verificationSuccess) { 
        console.log(`‚ùå Verification failed for ${email}: `, verificationResponse.status, verificationResponse.body);
    }
    
    sleep(3);
}

// üìå Function to Perform Login and Return Token
function login(email, password) {
    let payload = JSON.stringify({
        email: email,
        password: password
    });
    let headers = { 'Content-Type': 'application/json' };

    let res = http.post('https://dev-itona.xyz/api/auth/login', payload, { headers });

    let success = check(res, {
        '‚úÖ Login Successful': (r) => r.status === 200 && r.json('token') !== undefined,
    });

    if (!success) {
        console.error(`‚ùå Login Failed for ${email}:`, res.body);
        return null;
    }

    let token = res.json('token');
    console.log(`üîπ Token received for ${email}: ${token}`);
    return token;
}

// üìå Function to Create a Device
function createDevice(token) {
    let headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
    };

    let devicePayload = JSON.stringify({
        name: `Device-${__VU}-${Date.now()}`,
        type: 'sensor'
    });

    let deviceRes = http.post('https://dev-itona.xyz/api/devices', devicePayload, { headers });
    let deviceSuccess = check(deviceRes, { 'Device created': (r) => r.status === 201 });

    if (!deviceSuccess) {
        console.error("‚ùå Device Creation Failed!");
        return;
    }

    let deviceId = deviceRes.json('id');
    console.log(`üì° Device Created with ID: ${deviceId}`);
    sendTelemetry(deviceId);
}

// üìå Function to Send Telemetry Data via MQTT
function sendTelemetry(deviceId) {
    const brokerUrl = "mqtt://localhost:1883";
    const topic = "telemetry/data";
    const client = new mqtt.Client([brokerUrl]);
    
    try {
        client.connect();
    } catch (error) {
        console.error("‚ùå MQTT Connection Failed!", error);
        return;
    }

    for (let i = 0; i < 6; i++) { // Send telemetry every 5s for 30s
        let telemetryData = JSON.stringify({
            deviceId: deviceId,
            temperature: (Math.random() * 50).toFixed(2), // Simulate temperature data
            humidity: (Math.random() * 100).toFixed(2) // Simulate humidity data
        });

        client.publish(topic, telemetryData, { qos: 1 });
        console.log(`üì° Telemetry Sent: ${telemetryData}`);
        sleep(5); // Wait for 5 seconds before next telemetry
    }
    client.close();
}